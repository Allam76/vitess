#!/bin/bash
#
# Validate that the current version of the generated parser matches the output
# generated by the version of goyacc installed on the local system.

CUR="sql.go"
TMP="/tmp/sql.$$.go"
trap "rm -f $TMP" EXIT

set -e

if ! cd go/vt/sqlparser/ ; then
        echo "ERROR: $0 must be run in the root project directory"
        exit 1
fi

output=$(go run golang.org/x/tools/cmd/goyacc -o $TMP sql.y)

if [ -n "$output" ]; then
    echo "Expected empty output from goyacc, got:"
    echo $output
    exit 1
fi

gofmt -w $TMP

if [[ `diff -y --suppress-common-lines $TMP $CUR | wc -l` -gt 1 ]] ; then
        echo "ERROR: Regenerated parser $TMP does not match current version $(pwd)/sql.go:"
        diff -u $TMP $CUR
        echo
        echo "Please ensure go and goyacc are up to date and re-run 'make parser' to generate."
        exit 1
fi
